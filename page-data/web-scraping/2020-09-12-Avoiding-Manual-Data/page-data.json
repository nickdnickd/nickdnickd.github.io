{"componentChunkName":"component---src-templates-blog-post-js","path":"/web-scraping/2020-09-12-Avoiding-Manual-Data/","result":{"data":{"site":{"siteMetadata":{"title":"Nick D Blog"}},"markdownRemark":{"id":"0668c5e7-458f-562b-97ae-e688608035b9","excerpt":"Interview Season Doctors have it rough. After graduating medical school, they enter a period of indentured servitude known as residency. It is not uncommon to…","html":"<h2>Interview Season</h2>\n<p>Doctors have it rough. After graduating medical school, they enter a period of indentured servitude known as <em>residency</em>. It is not uncommon to hear of over 80 hour weeks, 12 hour shifts and DOMA’s. DOMA stands for “Day Off, My Ass” which describes the period of time between a night shift, letting out at 7am, and a day shift starting at 7am. Technically 24 hours, but most of it is spent asleep. In between these brutal shifts, a resident very near and dear to my heart has begun interviewing for a fellowship. A fellowship is a brief extension to residency that allows a doctor to focus on a specific area within their field of medicine. One example is ultrasound. This is a rapidly developing subspecialty of emergency medicine because it provides a quick, noninvasive view of a patient’s internal state. </p>\n<p>Throughout the country there are over 100 ultrasound fellowship programs, all vying for candidates on <a href=\"https://eusfellowships.com/\">this website</a>. I have visited this site over 100 times to help my SO compare and contrast.\nIt’s not the most beautiful website, but it gets the job done. One can tell that the data are organize in some sort of database behind the scenes and uses PHP (something I know nothing about). However, the site’s frontend takes the form of a tree-like structure with different characteristics nested in links on the side pane.</p>\n<h2>The boring way</h2>\n<p>Say I want to compare the salaries of 20 different programs. To view all of the programs, you have to go to <a href=\"https://eusfellowships.com/program-list-new/\">/program-list-new</a>. Once there you must click on a program, then click <strong>Read More</strong>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/84164261b6dac6fdb9b1b6f2c67f9239/0e758/program-list.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB80lEQVQoz3WRW2/UMBSE98fTvQBCQMsD/4Y33pB44CLRbQtb7bZJfIsdx042GcZOtq2KsPRprBN7Mud4cXHxAefvz/H6zTucvXqLl5sNzl4ssV6tsTxbktWky1VmneC39WqFDXWT9+uH/QLz2kfgczGg7Y/w/YD/rSPxJMxqR6Cl1uPE4o9ucVtH/CoMvt7c4cdtiZ97ge/Ub7sia+JKOOxMwLXyuJKPbMk1uRQNtsI/Jhz6Dq42pEatVaaxBlZLOKMw9nE+OT5jmJm+LYaRxeEI2wRclQ12qsWWWtQBhrXSBggXcKc97nWDe+NxUA320qFpI/q+R+x6HIRBJTUWYzKMAcfG4U5ZHnYoa482dthVFl9+S45A08xns7Jus/merbc0Suumcvj46RLbg5oN5/ANTVyIaEKHyMex1kIpDSklDEcwoVEbDcvx1ByP1gaSZ4QyaNtwMhwxDAOk9ZCufVDFy2VZohICZVWhqiZNFGUFwXo115VSNGwfE6ZZqmRCBA0dU6YEpwsTNGFaIWTWUy2ppKH3/knLVMch1wkfOcMexpgpxUzaZ6M5WTI+JXfOIYTwJOEwojBNTmhpapkwtVwUBdsr2XqV288tn/bU9FPDTpwPiDH+m9AzWeDDRA5ec9A+PRD/HJ6RLie6rsvquyHf+wtJBIHh0JuYZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"png\"\n        title=\"png\"\n        src=\"/static/84164261b6dac6fdb9b1b6f2c67f9239/fcda8/program-list.png\"\n        srcset=\"/static/84164261b6dac6fdb9b1b6f2c67f9239/12f09/program-list.png 148w,\n/static/84164261b6dac6fdb9b1b6f2c67f9239/e4a3f/program-list.png 295w,\n/static/84164261b6dac6fdb9b1b6f2c67f9239/fcda8/program-list.png 590w,\n/static/84164261b6dac6fdb9b1b6f2c67f9239/efc66/program-list.png 885w,\n/static/84164261b6dac6fdb9b1b6f2c67f9239/c83ae/program-list.png 1180w,\n/static/84164261b6dac6fdb9b1b6f2c67f9239/0e758/program-list.png 2502w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>We are then met with the program page. Once there, on the left pane, under Fellowship Program header, click the Fellowship Program link.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/48bdce51b7312bbb5087d6fcc09812fc/ddb69/program-salary.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB9UlEQVQoz32SSY/TQBCF/Ze5IcFlhixKEIPggsQFNIdBHBBXNMsJAQKRUTKEIaudzuIFu70m8RLbj+5mHDmJoKRP9dyt6q5XbenkyQmOGk9RqTdxfPwI9XoDzeZjNBtNVCs1VCpVQZVRq9YOqNd2tQQWXQcI4hTIN/hfRIzkLhcEORDiLyuGNPNCvO05eNGhgtddGwpdglg+COUEUJgeGC7DQ1930ONoDkamD9leQykhOry8neHNdwVn1wQfejpsL8B4pmPE6E9UkIUOh5oIXAeeQ+FSC9Q0EK6CAxdSGoZ415Jx2pri5TeC07YKO1iDaCY0y4UXZQjTf48hy3PkJaQ8SXDeGePs80+87xBc9XWYhgHHpkjiGOkmwSaJETOdZZko4rnQHB7bAxFHmA9+Ydhtw/+tIrJ0LB0b1HGwXC4Fvu+LXBTvR3ld4vLHQMan6xu0+zImBgW1bciyDIN1GgTBDp7nCbh2XRdRFO12mGY5XrXmeHg5xIOrMZ5/XcB2PcymU6iatrVatljYTtP0oGspZQvPvhDcvxjh3rmMo49zZteFqi6wXoeM9Q6r1UoQssdM2PzL8MslfsOtMkN7OMGNssBgYcK+s6yxDjnceoGu62LNsqztfMuw/5BZYC+ZJRHLMftMxQYhRMyoKNqfH898bz/+APhudnJiAREZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"png\"\n        title=\"png\"\n        src=\"/static/48bdce51b7312bbb5087d6fcc09812fc/fcda8/program-salary.png\"\n        srcset=\"/static/48bdce51b7312bbb5087d6fcc09812fc/12f09/program-salary.png 148w,\n/static/48bdce51b7312bbb5087d6fcc09812fc/e4a3f/program-salary.png 295w,\n/static/48bdce51b7312bbb5087d6fcc09812fc/fcda8/program-salary.png 590w,\n/static/48bdce51b7312bbb5087d6fcc09812fc/efc66/program-salary.png 885w,\n/static/48bdce51b7312bbb5087d6fcc09812fc/c83ae/program-salary.png 1180w,\n/static/48bdce51b7312bbb5087d6fcc09812fc/ddb69/program-salary.png 2684w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Here we have the salary- now enter this in a spreadsheet and do the other 20. You know what? Add Location, Year Founded (age matters here), Salary, Hours, Benefits, Number of Sites, Do they Bill for Ultrasounds? Are the Moonlight opportunites?, etc. Under the <strong>Fellowship Program</strong> header on the left, both the Program Description and Fellowship Program links for each program contain all of this information, so I’ll see you in a few hours.</p>\n<h2>No thank you</h2>\n<p>Wait a second… check out the url bar. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4e738fe7ccbc38975be5986700025839/f1901/url-bar.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.108108108108107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXElEQVQI122NSw6AIBBDvZD88QMKMqj3v1HNTMLORdM2nbyZSiWw9nSKh7ghHxXOL1DaQRuPWVlxlrFBOm+ch/PGeWr0oNEtMOovUi6oV4cPq0AH2Lr4q/GE77l/emlA8UOBahEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"program page url\"\n        title=\"program page url\"\n        src=\"/static/4e738fe7ccbc38975be5986700025839/fcda8/url-bar.png\"\n        srcset=\"/static/4e738fe7ccbc38975be5986700025839/12f09/url-bar.png 148w,\n/static/4e738fe7ccbc38975be5986700025839/e4a3f/url-bar.png 295w,\n/static/4e738fe7ccbc38975be5986700025839/fcda8/url-bar.png 590w,\n/static/4e738fe7ccbc38975be5986700025839/efc66/url-bar.png 885w,\n/static/4e738fe7ccbc38975be5986700025839/f1901/url-bar.png 942w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The portion after the question mark is known as a <em>query parameter</em>. This <code class=\"language-text\">program=83</code> is a hint to me that our browsers are querying the website for different programs by id. Also the fact that the id for this program is a simple integer, as opposed some random <a href=\"https://en.wikipedia.org/wiki/Universally_unique_identifier\">uuid</a> like <code class=\"language-text\">10d15da5-6cea-4bd8-814d-e9653b29a7d3</code>, suggests that programs have monitonically increasing id’s (1, 2, 3, etc). Clicking around other sites has confirmed this.</p>\n<p>Can I stubbornly avoid clicking through these links and run something that will crawl through all program pages? Can I spend 4 hours learning something new that might have just taken 2 hours to do?</p>\n<h2>Forget Gritty, are you Scrapy?</h2>\n<p>When thinking about web crawlers, I originially thought they’d just be a light python library that I would just include and run on a base url.\nWhat I was met with was an entire platform for running distributed web crawlers called <a href=\"https://docs.scrapy.org/en/latest/intro/overview.html\">scrapy</a>.</p>\n<p>Following along with the <a href=\"https://docs.scrapy.org/en/latest/intro/tutorial.html\">tutorial</a>, we make our tweaks along the way.</p>\n<h3>Step 0, create a virtual python environment and install scrapy</h3>\n<p>We do this to keep the global python environment clean. Dependencies can get tangled up with version numbers. Check <a href=\"https://realpython.com/python-virtual-environments-a-primer/\">this</a> out for a fantastic primer.</p>\n<p><code class=\"language-text\">python3 -m venv venv_scrapy</code></p>\n<p><code class=\"language-text\">source venv_scrapy/bin/activate</code></p>\n<p><code class=\"language-text\">pip install Scrapy</code></p>\n<h3>Step 1, create a project</h3>\n<p><code class=\"language-text\">scrapy startproject usfellowships</code></p>\n<h3>Step 2, check out the structure</h3>\n<p>A directory layout and boiler play file appear as follows:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 336px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/605f6270deeace5c7c047fd234f60c0e/d99f2/scrapy-layout.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 209.45945945945948%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"scrapy project layout\"\n        title=\"scrapy project layout\"\n        src=\"/static/605f6270deeace5c7c047fd234f60c0e/d99f2/scrapy-layout.png\"\n        srcset=\"/static/605f6270deeace5c7c047fd234f60c0e/12f09/scrapy-layout.png 148w,\n/static/605f6270deeace5c7c047fd234f60c0e/e4a3f/scrapy-layout.png 295w,\n/static/605f6270deeace5c7c047fd234f60c0e/d99f2/scrapy-layout.png 336w\"\n        sizes=\"(max-width: 336px) 100vw, 336px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>I’ve highlighted <code class=\"language-text\">spiders/us_fellowships.py</code> because this “spider” is where most of our code goes.</p>\n<p>Let’s dive into the structure and code</p>\n<h2>Step 4, our spider</h2>\n<h3>Spider file setup</h3>\n<p>These are the global constants and libraries pull in to set up the spider.\nIt was here where I declare the start and end to the program id’s. No id goes above 150 and when we find an empty page, skip over that.\n<code class=\"language-text\">position_headers</code> is a dictionary for us to translate the headers inside the webpage into more consise data columns. </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> scrapy\n<span class=\"token keyword\">from</span> urllib<span class=\"token punctuation\">.</span>parse <span class=\"token keyword\">import</span> urlparse\n\nSTART_RANGE <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\nEND_RANGE <span class=\"token operator\">=</span> <span class=\"token number\">150</span>\n\nposition_headers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Salary\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"salary\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Number of Clinical Hours\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"hours\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Number of Sites\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sites\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Year Fellowship Started\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"founded\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Do you bill for ultrasounds?\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"bill\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Do you require follow up imaging for patients who get ultrasounds?\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"follow_up\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Spider class and attribute definition</h3>\n<p>Our Spiders are a child class of base class <code class=\"language-text\">python scrapy.Spider</code>. The key attribute here is <code class=\"language-text\">start_urls</code>. I use this list to declare all of the program descriptions I will walk through, including the overall list which gives us location and id to name mapping.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UltrasoundSpider</span><span class=\"token punctuation\">(</span>scrapy<span class=\"token punctuation\">.</span>Spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    name <span class=\"token operator\">=</span> <span class=\"token string\">\"us_fellowships\"</span>\n    allowed_domains <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"eusfellowships.com\"</span><span class=\"token punctuation\">]</span>\n    start_urls <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>\n            <span class=\"token string-interpolation\"><span class=\"token string\">f\"https://eusfellowships.com/program-fellowship-position/?program=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>program_number<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n            <span class=\"token keyword\">for</span> program_number <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>START_RANGE<span class=\"token punctuation\">,</span> END_RANGE<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span>\n        <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string-interpolation\"><span class=\"token string\">f\"https://eusfellowships.com/program-description/?program=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>program_number<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n            <span class=\"token keyword\">for</span> program_number <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>START_RANGE<span class=\"token punctuation\">,</span> END_RANGE<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span>\n        <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://eusfellowships.com/program-list-new/\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<h3>The Parse function</h3>\n<p>There are three types of url in our scenario: program list, program description, and fellowship position. For ease of use, each type of webpage has an id as well as the kind of information on that page. For example, the program list contains all of the program titles and locations.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">    <span class=\"token keyword\">def</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n        current_url <span class=\"token operator\">=</span> urlparse<span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span></code></pre></div>\n<h4>Parse program list for information</h4>\n<p>The program list convienently contains all of the program id’s, titles and locations with currently active ultrasound programs. The key question to me was “what is the actual container of information on this site?“. Looking closer at the structure, we have to dig into the html elements of the website using Developer Tools.</p>\n<p>The spot that contains the location, program id and title for each program is the detail panel that appears when one clicks on a particular program.\nWith Developer tools open, click one of the links and hover around the header. You would see somethoing like the following:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8dc6aa3a7340d63612716a5e7f659e13/7f486/program-detail.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACV0lEQVQoz2WS205TQRhG+w4GUBMjVNpuetw90HNLlCCPgI9haiJoSJRLL7xQUQTaKjUBNfEBEChqNPGAQo1UW2ppaQsWBTlEBYQsh11qYtzJyjdzsVe+mX9Uw8MjXOm7SzQqCEeIDQ1xJxIlEg4r+2gkQngwzL1YjI6OM9TXN2Azm7DLVmyyXEmLhWabHY/bi+onMLMOq7uwvgc7Yv/7gO0DNql83Zd7MDZJtPudeGxmZJMRs9GASS9hNkjodRpUq99/sVjYYKGwydrGNqtra5SXv/GlvMzG5g92dvfY2t5RhGdDIY6qtZz0e2l3mHDLZpxWWUhNnGjUolarUZW+LjKZSDA1l2J6Ps1MLqUwnf3EbPEzqaUciYU0K1srXOg8z7HjDbQEfbT5LQT9dgIBF06vHdluxmTQo0qXs1x9/JEbE3luxucFOYVeQf/TPOFnC3Q/ShKfy9Bz6SKNGglfWyue01a8rTLeU0Im0hoU9+hwoMqUc9wazzA4WRIUKjypUlTy+miet8USXZ0hDtXUYnX5CdjttNhl3GYjRq2EoUmPRidVhWkGhKg/nv+PgUnRfCzPu1JJHDlETd0RrGKisskgpmtCli3ojUYkSUKj1VaFKUW4//Nf4tW1uILxnCLsOhA6XS7xTGRcDhsO0bRJr0en0ylS1ZwQ9o5luD1Rom+8QN9EUaz/5drognLk/Ya1tYfx+Xw4mpux7Te1indos2EVqa00zDL0fIr7r5KMvPwgcpYHr6skefgmSezFexJLWdHwHHWiYSAYxOv14Ha7cTqdOMQwqvkHNYYIdU0t/7UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"program detail\"\n        title=\"program detail\"\n        src=\"/static/8dc6aa3a7340d63612716a5e7f659e13/fcda8/program-detail.png\"\n        srcset=\"/static/8dc6aa3a7340d63612716a5e7f659e13/12f09/program-detail.png 148w,\n/static/8dc6aa3a7340d63612716a5e7f659e13/e4a3f/program-detail.png 295w,\n/static/8dc6aa3a7340d63612716a5e7f659e13/fcda8/program-detail.png 590w,\n/static/8dc6aa3a7340d63612716a5e7f659e13/efc66/program-detail.png 885w,\n/static/8dc6aa3a7340d63612716a5e7f659e13/c83ae/program-detail.png 1180w,\n/static/8dc6aa3a7340d63612716a5e7f659e13/7f486/program-detail.png 3010w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Here we can see that the container of this information is <code class=\"language-text\">fellowshipPrograms__content</code> inside an html <code class=\"language-text\">&lt;div&gt;</code>. This class name is queried in scrapy with the <code class=\"language-text\">response.css()</code> method, which collects all of the elements matching the search term. The search term syntax is <code class=\"language-text\">html_element.css_classname</code>. Putting that together, our container of valuable information can be found with <code class=\"language-text\">programs_content = response.css(&quot;div.fellowshipPrograms__content&quot;)</code></p>\n<p>Once we have the content panel, we must query the children of the element for the actual text we need. Inside content, there is title. This is the program title that we want in our output. To get this string simply add <code class=\"language-text\">::text</code> to the query term of the html tag and call the <code class=\"language-text\">.get()</code> metho on the result. This content happens to be part of a paragraph element, <code class=\"language-text\">&lt;p&gt;</code>. The final query looks like <code class=\"language-text\">title = prog.css(&quot;p.fellowshipPrograms__content__title::text&quot;).get()</code></p>\n<p>Finally, <code class=\"language-text\">data_row</code> is the dictionary that holds information for each webpage we visit. It will return the data in the result <code class=\"language-text\">out.json</code> file.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">        <span class=\"token comment\"># Get all programs list data</span>\n        <span class=\"token keyword\">if</span> response<span class=\"token punctuation\">.</span>url <span class=\"token operator\">==</span> <span class=\"token string\">\"https://eusfellowships.com/program-list-new/\"</span><span class=\"token punctuation\">:</span>\n            programs_content <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"div.fellowshipPrograms__content\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">for</span> prog <span class=\"token keyword\">in</span> programs_content<span class=\"token punctuation\">:</span>\n                data_row <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n                title <span class=\"token operator\">=</span> prog<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"p.fellowshipPrograms__content__title::text\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                location <span class=\"token operator\">=</span> prog<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span>\n                    <span class=\"token string\">\"span.fellowshipPrograms__content__location::text\"</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                program_id <span class=\"token operator\">=</span> prog<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"a.fellowshipPrograms__button\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>attrib<span class=\"token punctuation\">[</span><span class=\"token string\">\"href\"</span><span class=\"token punctuation\">]</span>\n                data_row<span class=\"token punctuation\">[</span><span class=\"token string\">\"program_id\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> program_id<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"program=\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n                data_row<span class=\"token punctuation\">[</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> title\n                data_row<span class=\"token punctuation\">[</span><span class=\"token string\">\"location\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> location\n                <span class=\"token keyword\">yield</span> data_row\n\n            <span class=\"token keyword\">return</span></code></pre></div>\n<h4>Parse the description pages</h4>\n<p>And that’s the essence of css-based web scraping. Apply this approach to the two other types of web pages and data_row will soon contain all of the useful information from the website.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">        <span class=\"token comment\"># Step 0 - get program id</span>\n        program_id <span class=\"token operator\">=</span> current_url<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"=\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"program_id: \"</span><span class=\"token punctuation\">,</span> program_id<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Step 1 - Get the title of the program</span>\n        program_main <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"div.programExtra__main\"</span><span class=\"token punctuation\">)</span>\n        \n        program_title <span class=\"token operator\">=</span> program_main<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"h2.programExtra__main__title::text\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Title: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>program_title<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        program_content <span class=\"token operator\">=</span> program_main<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"div.programsExtra__main__content\"</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> program_title<span class=\"token punctuation\">:</span>\n            <span class=\"token comment\"># print(f\"Program Content: {program_content.get()}\")</span>\n            program_headings <span class=\"token operator\">=</span> program_content<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span>\n                <span class=\"token string\">\"h4.programsExtra__heading::text\"</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>getall<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            program_textareas_raw <span class=\"token operator\">=</span> program_content<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span>\n                <span class=\"token string\">\"p.programsExtra__textarea\"</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>getall<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n            program_textareas <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>program_textareas_raw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                program_textareas_raw <span class=\"token operator\">=</span> program_content<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span>\n                    <span class=\"token string\">\"div.programsExtra__textarea\"</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>getall<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">for</span> raw_textarea <span class=\"token keyword\">in</span> program_textareas_raw<span class=\"token punctuation\">:</span>\n\n                    program_textareas<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>\n                        raw_textarea<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span>\n                            <span class=\"token string\">'&lt;div class=\"programsExtra__textarea\">'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span>\n                        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;/div>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                program_textareas <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                    raw_textarea<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span>\n                        <span class=\"token string\">'&lt;p class=\"programsExtra__textarea\">'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span>\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;/p>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"&amp;gt;\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">for</span> raw_textarea <span class=\"token keyword\">in</span> program_textareas_raw\n                <span class=\"token punctuation\">]</span>\n\n            data_row <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n            data_row<span class=\"token punctuation\">[</span><span class=\"token string\">\"program_id\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> program_id\n            <span class=\"token keyword\">for</span> heading<span class=\"token punctuation\">,</span> textarea <span class=\"token keyword\">in</span> <span class=\"token builtin\">zip</span><span class=\"token punctuation\">(</span>program_headings<span class=\"token punctuation\">,</span> program_textareas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                heading_clean <span class=\"token operator\">=</span> heading<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span>\n                text_clean <span class=\"token operator\">=</span> textarea<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t\\n \"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">if</span> heading <span class=\"token punctuation\">:</span><span class=\"token operator\">=</span> position_headers<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>heading_clean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                    data_row<span class=\"token punctuation\">[</span>heading<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> text_clean\n\n            <span class=\"token keyword\">yield</span> data_row</code></pre></div>\n<h2>Runner</h2>\n<p>This combines all of the information together in <code class=\"language-text\">runner.py</code> (see directory structure above).</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">from</span> scrapy<span class=\"token punctuation\">.</span>cmdline <span class=\"token keyword\">import</span> execute\n\nos<span class=\"token punctuation\">.</span>chdir<span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>dirname<span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>realpath<span class=\"token punctuation\">(</span>__file__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n    execute<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'scrapy'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'crawl'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'us_fellowships'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-o'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'out.json'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">except</span> SystemExit<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span></code></pre></div>\n<p>Just run <code class=\"language-text\">python runner.py</code> and watch the machine churn.</p>\n<h2>Results</h2>\n<p>Here is an except from <code class=\"language-text\">out.json</code> for id 53. </p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span><span class=\"token property\">\"program_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"53\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"salary\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"$115,000\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"hours\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"660\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"sites\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token property\">\"program_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"53\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"founded\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2006\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"bill\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"yes\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"follow_up\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"no\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token property\">\"program_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"53\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"title\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Temple University\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"location\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Philadelphia PA\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>Each type of web page yeiled different information.\nIn the end, it was easiest to parse process this file into a csv that contained a single row.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Program, Location, Founded, Salary, Hours, Benefits, Sites, Bill/FU Study?, Moonlight?\nTemple University,Philadelphia PA,2006,&quot;$115,000&quot;,660,,2,yes/no,,,</code></pre></div>","frontmatter":{"title":"Avoiding Manual Data Entry","date":"September 12, 2020","description":"At all costs"}}},"pageContext":{"slug":"/web-scraping/2020-09-12-Avoiding-Manual-Data/","previous":{"fields":{"slug":"/fft-basics/2018-01-16-Let-There-Be-Sound/"},"frontmatter":{"title":"Let There Be Sound"}},"next":{"fields":{"slug":"/async-uploads/2020-11-1-Async-Uploads/"},"frontmatter":{"title":"Asynchronous Uploads"}}}},"staticQueryHashes":["2841359383"]}